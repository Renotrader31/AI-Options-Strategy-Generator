<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üîß Spread P&L Calculation Test - FIXED</title>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            max-width: 800px; 
            margin: 50px auto; 
            padding: 20px;
            background: #f5f5f5;
        }
        .container { 
            background: white; 
            padding: 30px; 
            border-radius: 10px; 
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .test-case { 
            margin: 20px 0; 
            padding: 15px; 
            border: 2px solid #e0e0e0; 
            border-radius: 5px; 
        }
        .test-case.correct { 
            border-color: #4CAF50; 
            background-color: #f9fff9; 
        }
        .test-case.incorrect { 
            border-color: #f44336; 
            background-color: #fff9f9; 
        }
        .test-result { 
            font-weight: bold; 
            font-size: 1.1em; 
            margin: 10px 0; 
        }
        .correct .test-result { color: #4CAF50; }
        .incorrect .test-result { color: #f44336; }
        .run-button {
            background: #2196F3;
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 5px;
            font-size: 1rem;
            cursor: pointer;
            margin-bottom: 20px;
        }
        .run-button:hover { background: #1976D2; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîß Spread P&L Calculation Test</h1>
        <p>Testing the FIXED multi-leg option P&L calculation with 100x multiplier</p>
        
        <button class="run-button" onclick="runTest()">üöÄ Test Spread P&L Calculation</button>
        
        <div id="testResults"></div>
    </div>

    <script>
        // FIXED P&L calculation function (from the updated app/page.js)
        function calculateSpreadPnL(trade, exitPrice, closeQty = 1) {
            let closePnl, closePnlPercent;
            
            // Multi-leg strategies: P&L is net premium difference per contract * contracts * 100 shares per contract
            // FIXED: Option spreads need 100x multiplier like single options
            const isCredit = trade.netPremium > 0;
            if (isCredit) {
                // Credit spread: P&L = (collected credit - cost to close) * contracts * 100
                closePnl = (trade.entryPrice - exitPrice) * closeQty * 100;
            } else {
                // Debit spread: P&L = (exit value - paid debit) * contracts * 100
                closePnl = (exitPrice - trade.entryPrice) * closeQty * 100;
            }
            
            // FIXED: Multi-leg option percentage calculation needs 100x multiplier consistency
            closePnlPercent = Math.abs(trade.entryPrice) > 0 ? (closePnl / (Math.abs(trade.entryPrice) * closeQty * 100)) * 100 : 0;
            
            return { closePnl, closePnlPercent };
        }

        function runTest() {
            const results = document.getElementById('testResults');
            results.innerHTML = '';

            // Test Case: Your specific example - Buy $0.65, Sell $0.15, should profit $0.50 per contract
            const testCase = {
                name: "Debit Spread: Buy $0.65 - Sell $0.15",
                trade: {
                    assetType: 'MULTI_LEG_OPTION',
                    entryPrice: 0.50, // Net debit paid (0.65 - 0.15 = 0.50)
                    netPremium: -0.50, // Negative = debit spread
                    legs: [
                        { action: 'BUY', premium: 0.65 },
                        { action: 'SELL', premium: 0.15 }
                    ]
                },
                exitPrice: 0.00, // Close for worthless (max profit scenario)
                quantity: 1,
                expectedPnL: 50.00, // $0.50 profit per contract * 100 = $50
                expectedPercent: 100.00 // 100% return (made back full debit)
            };

            const result = calculateSpreadPnL(testCase.trade, testCase.exitPrice, testCase.quantity);
            const isCorrect = Math.abs(result.closePnl - testCase.expectedPnL) < 0.01;

            const testDiv = document.createElement('div');
            testDiv.className = `test-case ${isCorrect ? 'correct' : 'incorrect'}`;
            testDiv.innerHTML = `
                <h3>${testCase.name}</h3>
                <p><strong>Setup:</strong></p>
                <ul>
                    <li>Buy leg premium: $${testCase.trade.legs[0].premium}</li>
                    <li>Sell leg premium: $${testCase.trade.legs[1].premium}</li>
                    <li>Net debit paid: $${testCase.trade.entryPrice}</li>
                    <li>Exit price: $${testCase.exitPrice} (worthless)</li>
                    <li>Quantity: ${testCase.quantity} contract</li>
                </ul>
                <p><strong>Expected P&L:</strong> $${testCase.expectedPnL}</p>
                <p><strong>Calculated P&L:</strong> $${result.closePnl.toFixed(2)}</p>
                <p><strong>Expected %:</strong> ${testCase.expectedPercent}%</p>
                <p><strong>Calculated %:</strong> ${result.closePnlPercent.toFixed(2)}%</p>
                <div class="test-result">
                    ${isCorrect ? '‚úÖ CORRECT - Fixed calculation works!' : '‚ùå INCORRECT - Still has issues'}
                </div>
            `;
            
            results.appendChild(testDiv);

            // Additional test: Credit spread example
            const creditTestCase = {
                name: "Credit Spread: Sell $1.00 - Buy $0.35",
                trade: {
                    assetType: 'MULTI_LEG_OPTION',
                    entryPrice: 0.65, // Net credit received (1.00 - 0.35 = 0.65)
                    netPremium: 0.65, // Positive = credit spread
                    legs: [
                        { action: 'SELL', premium: 1.00 },
                        { action: 'BUY', premium: 0.35 }
                    ]
                },
                exitPrice: 0.00, // Close for worthless (max profit scenario)
                quantity: 1,
                expectedPnL: 65.00, // $0.65 credit * 100 = $65
                expectedPercent: 100.00
            };

            const creditResult = calculateSpreadPnL(creditTestCase.trade, creditTestCase.exitPrice, creditTestCase.quantity);
            const creditIsCorrect = Math.abs(creditResult.closePnl - creditTestCase.expectedPnL) < 0.01;

            const creditTestDiv = document.createElement('div');
            creditTestDiv.className = `test-case ${creditIsCorrect ? 'correct' : 'incorrect'}`;
            creditTestDiv.innerHTML = `
                <h3>${creditTestCase.name}</h3>
                <p><strong>Setup:</strong></p>
                <ul>
                    <li>Sell leg premium: $${creditTestCase.trade.legs[0].premium}</li>
                    <li>Buy leg premium: $${creditTestCase.trade.legs[1].premium}</li>
                    <li>Net credit received: $${creditTestCase.trade.entryPrice}</li>
                    <li>Exit price: $${creditTestCase.exitPrice} (worthless)</li>
                    <li>Quantity: ${creditTestCase.quantity} contract</li>
                </ul>
                <p><strong>Expected P&L:</strong> $${creditTestCase.expectedPnL}</p>
                <p><strong>Calculated P&L:</strong> $${creditResult.closePnl.toFixed(2)}</p>
                <p><strong>Expected %:</strong> ${creditTestCase.expectedPercent}%</p>
                <p><strong>Calculated %:</strong> ${creditResult.closePnlPercent.toFixed(2)}%</p>
                <div class="test-result">
                    ${creditIsCorrect ? '‚úÖ CORRECT - Fixed calculation works!' : '‚ùå INCORRECT - Still has issues'}
                </div>
            `;
            
            results.appendChild(creditTestDiv);

            // Summary
            const summaryDiv = document.createElement('div');
            summaryDiv.style.cssText = 'margin-top: 30px; padding: 20px; background: #f0f8ff; border-radius: 5px; text-align: center;';
            const allCorrect = isCorrect && creditIsCorrect;
            summaryDiv.innerHTML = `
                <h2>Test Summary</h2>
                <p style="font-size: 1.2rem; font-weight: bold; color: ${allCorrect ? '#4CAF50' : '#f44336'}">
                    ${allCorrect ? 'üéâ ALL TESTS PASSED - P&L calculation is FIXED!' : '‚ö†Ô∏è Some tests failed - needs more debugging'}
                </p>
                <p style="margin-top: 15px;">
                    <strong>Key Fix:</strong> Added 100x multiplier for option spreads to match single option calculation.<br>
                    Each option contract represents 100 shares, so P&L must be multiplied by 100.
                </p>
            `;
            
            results.appendChild(summaryDiv);
        }
    </script>
</body>
</html>